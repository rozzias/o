<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>rowatel</title>
  <script>
    // lightweight license gate (unchanged)
    if (localStorage.getItem("license_valid") !== "true") {
      window.location.href = "license.html";
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: linear-gradient(180deg,#e9f8ff 0%, #f6f8ff 40%, #fbf7ff 100%);
      --card-bg: rgba(255,255,255,0.85);
      --glass: rgba(255,255,255,0.6);
      --accent-a: #00c2c7; /* turkus */
      --accent-b: #7b3cff; /* fiolet */
      --accent-c: #3aa0ff; /* błękit */
      --muted: #6b7280;
      --text: #0b1220;
      --radius: 18px;
      --shadow-1: 0 12px 40px rgba(11,18,32,0.08);
      --shadow-2: 0 8px 24px rgba(11,18,32,0.06);
      --glass-border: rgba(255,255,255,0.6);
      --success: #16a34a;
      --error: #dc2626;
      --transition: 240ms cubic-bezier(.2,.9,.3,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: var(--bg-1);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px;
    }

    /* Mobile-first container */
    .wrap{
      width:100%;
      max-width:420px;
      margin:10px;
    }

    .card {
      border-radius:24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,255,0.82));
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: var(--shadow-1);
      padding:18px;
      overflow:hidden;
    }

    /* header decorative */
    .hero {
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px 6px 18px 6px;
    }
    .logo {
      width:56px;height:56px;border-radius:14px;
      background: linear-gradient(135deg,var(--accent-a),var(--accent-b));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;
      box-shadow: 0 12px 30px rgba(123,60,255,0.16);
      border:1px solid rgba(255,255,255,0.2);
    }
    .title h1{margin:0;font-size:18px;letter-spacing:0.4px}
    .title p{margin:4px 0 0 0;color:var(--muted);font-size:13px}

    form{margin-top:6px}

    /* floating accent top-right */
    .accent-bubble{
      position:absolute;
      right: -60px;
      top: -60px;
      width:220px;height:220px;border-radius:40px;
      background: radial-gradient(circle at 30% 30%, rgba(59,160,255,0.18), transparent 30%),
                  radial-gradient(circle at 80% 80%, rgba(123,60,255,0.14), transparent 30%);
      transform: rotate(12deg);
      filter: blur(10px);
      pointer-events:none;
    }

    /* form grid */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .full{grid-column:1/-1}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600}
    .input, select, .file-btn{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(11,18,32,0.06);
      background:linear-gradient(180deg,#fff,#fbfbff);
      font-size:15px;color:var(--text);
      outline:none;
      box-shadow: var(--shadow-2);
      transition:box-shadow var(--transition), transform var(--transition), border-color var(--transition);
    }
    .input:focus, select:focus, .file-btn:focus{box-shadow:0 18px 40px rgba(11,18,32,0.08);transform:translateY(-2px);border-color:rgba(10,120,200,0.12)}

    /* special big fields */
    .file-wrapper{position:relative; display:flex; flex-direction:column; gap:8px}
    .file-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .file-btn{display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;background:linear-gradient(90deg,var(--accent-c),var(--accent-b));color:#fff;font-weight:700;border:none;padding:12px 14px;border-radius:12px}
    .file-note{font-size:12px;color:rgba(255,255,255,0.9);opacity:0.9}
    .file-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.12);padding:10px;border-radius:10px;color:var(--muted)}

    .preview{display:none;margin-top:10px;border-radius:12px;overflow:hidden;border:1px solid rgba(11,18,32,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);padding:8px}
    .preview img{width:100%;max-height:220px;object-fit:cover;border-radius:8px}

    .controls{display:flex;gap:10px;margin-top:16px}
    .btn{
      flex:1;padding:12px 14px;border-radius:12px;font-weight:800;font-size:14px;cursor:pointer;border:none;transition:transform var(--transition),box-shadow var(--transition);
    }
    .btn-ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--text)}
    .btn-primary{background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:white;box-shadow:0 20px 50px rgba(59,160,255,0.12)}
    .btn-primary:hover{transform:translateY(-3px)}
    .btn-ghost:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(11,18,32,0.06)}

    .status{margin-top:8px;font-size:13px;color:var(--muted);min-height:18px}

    /* right small preview for mobile: sticky card */
    .mini-card{
      margin-top:12px;
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,255,0.92));
      border:1px solid rgba(11,18,32,0.04);
      box-shadow:0 12px 30px rgba(11,18,32,0.06);
    }
    .id-grid{display:flex;gap:12px;align-items:center}
    .id-photo{width:72px;height:72px;border-radius:10px;background:linear-gradient(90deg,var(--accent-a),var(--accent-c));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px}
    .id-meta{flex:1}
    .id-name{font-weight:800;font-size:15px}
    .id-sub{font-size:13px;color:var(--muted);margin-top:6px}

    /* footer */
    .foot{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
    .brand{font-weight:800}

    /* small screens tweak */
    @media (max-width:480px){
      .grid{grid-template-columns:1fr; gap:12px}
      .hero{gap:10px}
      .logo{width:52px;height:52px;border-radius:12px}
      .id-photo{width:62px;height:62px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <div class="accent-bubble" aria-hidden="true"></div>
      <div class="hero">
        <div class="logo" aria-hidden="false">RW</div>
        <div class="title">
          <h1 id="title">rowatel — Mobile Studio</h1>
          <p>Turkus • Fiolet • Błękit — perfekcja dopasowana do telefonu</p>
        </div>
      </div>

      <form id="dataGenerator" novalidate>
        <div class="grid">
          <div class="field">
            <label for="name">Imię</label>
            <input id="name" name="name" class="input" type="text" placeholder="Jan" required>
          </div>

          <div class="field">
            <label for="surname">Nazwisko</label>
            <input id="surname" name="surname" class="input" type="text" placeholder="Kowalski" required>
          </div>

          <div class="field">
            <label for="sex">Płeć</label>
            <select id="sex" name="sex" class="input" required>
              <option value="MĘŻCZYZNA">MĘŻCZYZNA</option>
              <option value="KOBIETA">KOBIETA</option>
            </select>
          </div>

          <div class="field">
            <label for="birthday">Data urodzenia</label>
            <input id="birthday" name="birthday" class="input" type="date" required>
          </div>

          <div class="field full">
            <label for="pesel">Numer PESEL</label>
            <input id="pesel" name="pesel" class="input" type="text" placeholder="11-cyfrowy numer" maxlength="11" pattern="[0-9]{11}" required>
          </div>

          <div class="field">
            <label for="mdow_series">Seria i numer mDowodu</label>
            <input id="mdow_series" name="mdow_series" class="input" type="text" placeholder="MWYC XXXXX" required>
          </div>

          <div class="field">
            <label for="issue_date">Data wydania mDowodu (DD.MM.RRRR)</label>
            <input id="issue_date" name="issue_date" class="input" type="text" placeholder="14.07.2023" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
          </div>

          <div class="field">
            <label for="expiry_date">Termin ważności mDowodu (DD.MM.RRRR)</label>
            <input id="expiry_date" name="expiry_date" class="input" type="text" placeholder="14.07.2028" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
          </div>

          <div class="field">
            <label for="father_name">Imię ojca</label>
            <input id="father_name" name="father_name" class="input" type="text" placeholder="Maciej" required>
          </div>

          <div class="field">
            <label for="mother_name">Imię matki</label>
            <input id="mother_name" name="mother_name" class="input" type="text" placeholder="Ewa" required>
          </div>

          <div class="field">
            <label for="nationality">Obywatelstwo</label>
            <input id="nationality" name="nationality" class="input" type="text" placeholder="POLSKIE" required>
          </div>

          <div class="field">
            <label for="birthPlace">Miejsce urodzenia</label>
            <input id="birthPlace" name="birthPlace" class="input" type="text" placeholder="Warszawa" required>
          </div>

          <div class="field">
            <label for="birth_country">Kraj urodzenia</label>
            <input id="birth_country" name="birth_country" class="input" type="text" placeholder="Polska" required>
          </div>

          <div class="field full">
            <label for="adress1">Adres (Ulica i numer)</label>
            <input id="adress1" name="adress1" class="input" type="text" placeholder="Chopina 4/56" required>
          </div>

          <div class="field">
            <label for="adress2">Kod pocztowy / nr</label>
            <input id="adress2" name="adress2" class="input" type="text" placeholder="42-250">
          </div>

          <div class="field">
            <label for="city">Miasto</label>
            <input id="city" name="city" class="input" type="text" placeholder="Warszawa">
          </div>

          <div class="field">
            <label for="home_date">Data zameldowania (DD.MM.RRRR)</label>
            <input id="home_date" name="home_date" class="input" type="text" placeholder="01.01.2000" maxlength="10" pattern="[0-9]{2}\.[0-9]{2}\.[0-9]{4}" required>
          </div>

          <div class="field">
            <label for="family_name">Nazwisko rodowe (Twoje)</label>
            <input id="family_name" name="family_name" class="input" type="text" placeholder="Kowalski / Panieńskie">
          </div>

          <div class="field">
            <label for="father_family_name">Nazwisko rodowe ojca</label>
            <input id="father_family_name" name="father_family_name" class="input" type="text" placeholder="Kowalski">
          </div>

          <div class="field">
            <label for="mother_family_name">Nazwisko rodowe matki</label>
            <input id="mother_family_name" name="mother_family_name" class="input" type="text" placeholder="Nowak">
          </div>
        </div>

        <div class="file-wrapper full" style="margin-top:12px">
          <label for="fileInput" style="font-size:13px;color:var(--muted);margin-bottom:8px;font-weight:700">Zdjęcie (JPG / PNG)</label>
          <div class="file-row">
            <div style="flex:1">
              <button type="button" class="file-btn" id="fileBtn" aria-haspopup="true">
                <span id="fileLabelText">Wybierz plik…</span>
                <span class="file-note">Rekomendacja: 600×600</span>
              </button>
            </div>
            <input id="fileInput" type="file" accept="image/jpeg,image/png" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer" required>
          </div>
          <div class="preview" id="imagePreviewContainer" aria-hidden="true">
            <img id="imagePreview" src="#" alt="podglad zdjecia">
          </div>
          <input type="hidden" id="image" name="image" value="">
          <div id="statusMessage" class="status" aria-live="polite"></div>
        </div>

        <div class="controls full">
          <button type="button" id="autofillButton" class="btn btn-ghost">Wypełnij daty</button>
          <button type="submit" id="generateButton" class="btn btn-primary">/// GENERUJ ///</button>
        </div>
        <div class="foot full" style="margin-top:12px">
          <div class="brand">Wallah</div>
          <div style="color:var(--muted)">Mobile Studio • Turkus • Fiolet • Błękit</div>
        </div>
      </form>
    </div>

    <!-- mini preview card below for mobile -->
    <div class="mini-card" aria-labelledby="preview-title" style="margin-top:12px">
      <div id="preview-title" style="font-weight:700;margin-bottom:8px">Podgląd karty</div>
      <div class="id-grid">
        <div class="id-photo" id="miniInitials">RW</div>
        <div class="id-meta">
          <div class="id-name" id="previewName">Imię Nazwisko</div>
          <div class="id-sub" id="previewSub">PESEL • Data urodzenia</div>
          <div style="font-size:13px;color:var(--muted);margin-top:8px" id="previewExtra">Miasto • Polska</div>
        </div>
      </div>
      <div style="margin-top:12px;font-size:13px;color:var(--muted)"><strong>Instrukcja:</strong> Dodaj do ekranu głównego, aby używać jak aplikacji (Safari/Chrome).</div>
    </div>
  </div>

  <script>
    // CLOUDINARY CONFIG (zmien przed produkcją)
    const CLOUD_NAME = 'dplomlrbd';   // <-- Zmień na swój klucz
    const UPLOAD_PRESET = 'ml_default'; // <-- Zmień na swój preset

    // elements
    const form = document.getElementById('dataGenerator');
    const fileInput = document.getElementById('fileInput');
    const fileBtn = document.getElementById('fileBtn');
    const fileLabelText = document.getElementById('fileLabelText');
    const imageURLInput = document.getElementById('image');
    const generateButton = document.getElementById('generateButton');
    const statusMessage = document.getElementById('statusMessage');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');

    const peselInput = document.getElementById('pesel');
    const issueDateInput = document.getElementById('issue_date');
    const expiryDateInput = document.getElementById('expiry_date');
    const homeDateInput = document.getElementById('home_date');
    const birthdayInput = document.getElementById('birthday');
    const previewName = document.getElementById('previewName');
    const previewSub = document.getElementById('previewSub');
    const previewExtra = document.getElementById('previewExtra');
    const miniInitials = document.getElementById('miniInitials');

    const manualDateFields = [issueDateInput, expiryDateInput, homeDateInput];

    // helpers
    function formatDateForDisplay(date){
      if (!(date instanceof Date) || isNaN(date)) return '';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}.${m}.${y}`;
    }
    function formatDateForURL(dateString){
      if (!dateString) return '';
      const parts = dateString.split('-');
      return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }
    function generateRandomFiveDigits(){ return Math.floor(10000 + Math.random()*90000); }

    // reactive preview updates
    function updatePreview(){
      const name = document.getElementById('name').value || 'Imię';
      const surname = document.getElementById('surname').value || 'Nazwisko';
      const pesel = peselInput.value || 'PESEL';
      const bday = birthdayInput.value ? formatDateForURL(birthdayInput.value) : 'DD.MM.RRRR';
      const city = document.getElementById('city').value || '';
      document.getElementById('previewName').textContent = `${name} ${surname}`;
      document.getElementById('previewSub').textContent = `${pesel} • ${bday}`;
      document.getElementById('previewExtra').textContent = `${city}${city ? ' • ' : ''}Polska`;
      const initials = ((name[0]||'R') + (surname[0]||'W')).toUpperCase();
      miniInitials.textContent = initials;
    }
    ['input','change'].forEach(evt => document.addEventListener(evt, updatePreview));

    // file button triggers file input (make entire visible area clickable)
    fileBtn.addEventListener('click', ()=> fileInput.click());
    // also allow clicking the visible preview area to replace
    imagePreviewContainer.addEventListener('click', ()=> fileInput.click());

    fileInput.addEventListener('change', function(){
      statusMessage.textContent = '';
      const file = this.files[0];
      if (!file){ imagePreviewContainer.style.display='none'; fileLabelText.textContent='Wybierz plik…'; return; }
      fileLabelText.textContent = file.name;
      const reader = new FileReader();
      reader.onload = function(e){
        imagePreview.src = e.target.result;
        imagePreviewContainer.style.display = 'block';
        imagePreviewContainer.setAttribute('aria-hidden','false');
        // set mini preview as well
        const mini = document.getElementById('miniInitials');
        mini.style.background = 'linear-gradient(90deg,var(--accent-a),var(--accent-c))';
        miniInitialsUpdated = ((document.getElementById('name').value[0]||'R') + (document.getElementById('surname').value[0]||'W')).toUpperCase();
        document.getElementById('miniInitials').textContent = miniInitialsUpdated;
      };
      reader.readAsDataURL(file);
      statusMessage.textContent = 'Zdjęcie załadowane lokalnie.';
    });

    // autofill button logic (polished)
    document.getElementById('autofillButton').addEventListener('click', function(){
      statusMessage.style.color = 'var(--error)';
      const birthDateValue = birthdayInput.value;
      if (!birthDateValue){ statusMessage.textContent = 'Wybierz datę urodzenia najpierw.'; return; }

      const birthDate = new Date(birthDateValue);
      const currentYear = new Date().getFullYear();
      const birthYear = birthDate.getFullYear();
      const isAdult = currentYear - birthYear >= 18;

      let issueDate;
      if (isAdult){
        issueDate = new Date(birthDate.getTime());
        issueDate.setFullYear(issueDate.getFullYear()+18);
        issueDate.setDate(issueDate.getDate()+1);
        if (issueDate > new Date()) issueDate = new Date();
      } else {
        issueDate = new Date(birthDate.getTime());
        issueDate.setFullYear(issueDate.getFullYear()+13);
        issueDate.setDate(issueDate.getDate()+1);
        if (issueDate > new Date()) issueDate = new Date();
      }
      const expiryDate = new Date(issueDate.getTime()); expiryDate.setFullYear(expiryDate.getFullYear()+5);
      const homeDate = new Date(birthDate.getTime()); homeDate.setFullYear(homeDate.getFullYear()+1);

      const birthMonth = birthDate.getMonth() + 1;
      const birthDay = birthDate.getDate();
      const birthYearMod = birthYear % 100;
      let peselMonth = birthMonth;
      if (birthYear >= 2000) peselMonth += 20;

      const sexVal = document.getElementById('sex').value || '';
      const sexLower = sexVal.toString().toLowerCase();
      let later = '0295';
      if (sexLower.indexOf('kob') !== -1) later = '0382';

      const dayStr = String(birthDay).padStart(2,'0');
      const monthStr = String(peselMonth).padStart(2,'0');

      const generatedPesel = String(birthYearMod).padStart(2,'0') + monthStr + dayStr + later + '7';
      peselInput.value = generatedPesel.substring(0,11);

      document.getElementById('mdow_series').value = `MWYC ${generateRandomFiveDigits()}`;
      issueDateInput.value = formatDateForDisplay(issueDate);
      expiryDateInput.value = formatDateForDisplay(expiryDate);
      homeDateInput.value = formatDateForDisplay(homeDate);

      statusMessage.style.color = 'var(--success)';
      statusMessage.textContent = 'Daty i numery wygenerowane pomyślnie.';
      updatePreview();
    });

    // validation helpers
    function validateDateFormat(input){
      const datePattern = new RegExp(input.pattern);
      if (!input.value) return !input.required;
      if (input.value.length !== 10 || !datePattern.test(input.value)) return false;
      return true;
    }
    function validatePeselFormat(input){
      const peselPattern = new RegExp(input.pattern);
      if (!input.value) return !input.required;
      if (input.value.length !== 11 || !peselPattern.test(input.value)) return false;
      return true;
    }

    // upload to cloudinary (async)
    async function uploadToCloudinary(file){
      if (CLOUD_NAME.startsWith('TWÓJ') || UPLOAD_PRESET.startsWith('TWÓJ')){
        statusMessage.style.color = 'var(--error)';
        statusMessage.textContent = 'BŁĄD: Ustaw CLOUD_NAME i UPLOAD_PRESET.';
        return null;
      }
      statusMessage.style.color = 'var(--muted)';
      statusMessage.textContent = 'Przesyłanie zdjęcia...';
      generateButton.disabled = true;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body: formData });
        const data = await res.json();
        if (data.url){ statusMessage.style.color='var(--success)'; statusMessage.textContent='Zdjęcie załadowane.'; return data.url; }
        else { statusMessage.style.color='var(--error)'; statusMessage.textContent='Błąd Cloudinary'; console.error(data); return null; }
      } catch(err){ statusMessage.style.color='var(--error)'; statusMessage.textContent='Błąd sieci/API.'; console.error(err); return null; }
      finally{ generateButton.disabled = false; }
    }

    // submit handler - mapping and redirect
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      for (const input of manualDateFields){
        if (!validateDateFormat(input)){
          statusMessage.style.color='var(--error)';
          statusMessage.textContent = `BŁĄD: Pole ${input.name} musi być w formacie DD.MM.RRRR.`;
          input.focus();
          return;
        }
      }
      if (!validatePeselFormat(peselInput)){
        statusMessage.style.color='var(--error)';
        statusMessage.textContent = 'BŁĄD: Numer PESEL musi zawierać 11 cyfr.';
        peselInput.focus();
        return;
      }
      if (!fileInput.files || fileInput.files.length===0){
        statusMessage.style.color='var(--error)';
        statusMessage.textContent = 'Wybierz plik zdjęcia.';
        return;
      }

      if (imageURLInput.value === ''){
        const imageUrl = await uploadToCloudinary(fileInput.files[0]);
        if (!imageUrl) return;
        imageURLInput.value = imageUrl;
      }

      const nameMap = {
        family_name: 'familyName',
        father_family_name: 'fathersFamilyName',
        mother_family_name: 'mothersFamilyName',
        birth_country: 'countryOfBirth'
      };
      const params = [];
      const allInputs = form.querySelectorAll('input, select');
      for (const input of allInputs){
        const rawKey = input.name;
        if (!rawKey) continue;
        let value = input.value || '';
        if (rawKey === 'birthday') value = formatDateForURL(input.value);
        if (rawKey === 'sex'){
          const v = (value||'').toString().toLowerCase();
          value = (v.indexOf('kob')!==-1 || v.indexOf('k')===0) ? 'k' : 'm';
        }
        if (rawKey === 'image' && imageURLInput.value) value = imageURLInput.value;
        const finalKey = nameMap[rawKey] || rawKey;
        params.push(`${finalKey}=${encodeURIComponent(value)}`);
      }

      const targetUrl = `id.html?${params.join('&')}`;
      generateButton.textContent = 'Tworzę...';
      generateButton.disabled = true;
      setTimeout(()=>{ window.location.href = targetUrl; }, 260);
    });
  </script>
</body>
</html>
